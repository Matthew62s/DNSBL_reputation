{% extends "base.html" %}

{% block title %}Targets - IP Reputation Monitor{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">Target Management</h1>

<!-- Add Target Form -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Add New Targets</div>
    </div>
    <form id="addTargetForm" onsubmit="addTargets(event)">
        <div class="form-group">
            <label for="targetsInput">IP Addresses or Domains (one per line, or comma-separated)</label>
            <textarea id="targetsInput" class="form-control" rows="5" required placeholder="1.2.3.4&#10;8.8.8.8&#10;example.com"></textarea>
        </div>
        <div class="form-group">
            <label for="targetType">Type</label>
            <select id="targetType" class="form-control">
                <option value="ip">IP Address</option>
                <option value="domain">Domain</option>
            </select>
        </div>
        <div class="form-group">
            <label for="targetLabel">Label (optional)</label>
            <input type="text" id="targetLabel" class="form-control" placeholder="e.g., Production Servers">
        </div>
        <div class="form-group">
            <label for="targetTags">Tags (comma-separated, optional)</label>
            <input type="text" id="targetTags" class="form-control" placeholder="e.g., production, email">
        </div>
        <button type="submit" class="btn btn-primary">‚ûï Add Targets</button>
    </form>
</div>

<!-- Filters -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Filters</div>
    </div>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <label for="searchInput">Search</label>
            <input type="text" id="searchInput" class="form-control" placeholder="IP or label...">
        </div>
        <div class="form-group" style="flex: 1; min-width: 150px;">
            <label for="typeFilter">Type</label>
            <select id="typeFilter" class="form-control">
                <option value="">All Types</option>
                <option value="ip">IP</option>
                <option value="domain">Domain</option>
            </select>
        </div>
        <div class="form-group" style="flex: 1; min-width: 150px;">
            <label for="statusFilter">Status</label>
            <select id="statusFilter" class="form-control">
                <option value="">All</option>
                <option value="enabled">Enabled</option>
                <option value="disabled">Disabled</option>
            </select>
        </div>
        <div class="form-group" style="flex: 0 0 auto;">
            <label>&nbsp;</label>
            <button class="btn btn-primary" onclick="loadTargets()">üîç Search</button>
        </div>
        <div class="form-group" style="flex: 0 0 auto;">
            <label>&nbsp;</label>
            <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
        </div>
    </div>
</div>

<!-- Targets Table -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Targets (<span id="targetCount">0</span>)</div>
        <button class="btn btn-sm btn-secondary" onclick="loadTargets()">üîÑ Refresh</button>
    </div>
    <div id="targetsList">
        <p class="loading">Loading targets...</p>
    </div>
</div>

<!-- Target Detail Modal (simplified) -->
<div id="targetDetail" class="card" style="display: none; margin-top: 2rem;">
    <div class="card-header">
        <div class="card-title">Target Detail</div>
        <button class="btn btn-sm btn-secondary" onclick="closeDetail()">‚úï Close</button>
    </div>
    <div id="targetDetailContent"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTargets = [];

async function loadTargets() {
    const search = document.getElementById('searchInput').value;
    const type = document.getElementById('typeFilter').value;
    const status = document.getElementById('statusFilter').value;

    let url = `/api/targets?limit=100`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (type) url += `&type_filter=${type}`;
    if (status) url += `&status_filter=${status}`;

    try {
        const response = await fetch(url);
        const data = await response.json();
        currentTargets = data.items;

        document.getElementById('targetCount').textContent = data.total;

        if (data.items.length === 0) {
            document.getElementById('targetsList').innerHTML = '<p>No targets found</p>';
            return;
        }

        let html = '<table><thead><tr><th>Target</th><th>Type</th><th>Label</th><th>Tags</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
        data.items.forEach(item => {
            const tags = item.tags.map(t => `<span class="badge badge-secondary">${t}</span>`).join(' ');
            html += `
                <tr>
                    <td><strong>${item.target}</strong></td>
                    <td><span class="badge badge-secondary">${item.type}</span></td>
                    <td>${item.label || '-'}</td>
                    <td>${tags || '-'}</td>
                    <td><span class="badge badge-${item.enabled ? 'success' : 'secondary'}">${item.enabled ? 'Enabled' : 'Disabled'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewDetail(${item.id})">View</button>
                        <button class="btn btn-sm ${item.enabled ? 'btn-warning' : 'btn-success'}" onclick="toggleTarget(${item.id})">${item.enabled ? 'Disable' : 'Enable'}</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTarget(${item.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
        html += '</tbody></table>';
        document.getElementById('targetsList').innerHTML = html;
    } catch (error) {
        console.error('Error loading targets:', error);
        document.getElementById('targetsList').innerHTML = '<p class="alert alert-danger">Error loading targets</p>';
    }
}

async function addTargets(event) {
    event.preventDefault();

    const targetsInput = document.getElementById('targetsInput').value;
    const targets = targetsInput.split(/[\n,]+/).map(t => t.trim()).filter(t => t);

    if (targets.length === 0) {
        alert('Please enter at least one IP or domain');
        return;
    }

    const type = document.getElementById('targetType').value;
    const label = document.getElementById('targetLabel').value || null;
    const tags = document.getElementById('targetTags').value ?
        document.getElementById('targetTags').value.split(',').map(t => t.trim()).filter(t => t) : null;

    try {
        const response = await fetch('/api/targets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ targets, type, label, tags })
        });

        if (response.ok) {
            alert('Targets added successfully!');
            document.getElementById('addTargetForm').reset();
            loadTargets();
        } else {
            const error = await response.json();
            alert('Failed to add targets: ' + error.detail);
        }
    } catch (error) {
        console.error('Error adding targets:', error);
        alert('Error adding targets: ' + error.message);
    }
}

async function toggleTarget(id) {
    const target = currentTargets.find(t => t.id === id);
    if (!target) return;

    try {
        const response = await fetch(`/api/targets/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: !target.enabled })
        });

        if (response.ok) {
            loadTargets();
        } else {
            alert('Failed to update target');
        }
    } catch (error) {
        console.error('Error updating target:', error);
        alert('Error updating target: ' + error.message);
    }
}

async function deleteTarget(id) {
    if (!confirm('Are you sure you want to delete this target?')) return;

    try {
        const response = await fetch(`/api/targets/${id}`, { method: 'DELETE' });

        if (response.ok) {
            alert('Target deleted successfully');
            loadTargets();
        } else {
            alert('Failed to delete target');
        }
    } catch (error) {
        console.error('Error deleting target:', error);
        alert('Error deleting target: ' + error.message);
    }
}

async function viewDetail(id) {
    try {
        const response = await fetch(`/api/status/history/${id}`);
        const data = await response.json();

        const target = currentTargets.find(t => t.id === id);
        const detailDiv = document.getElementById('targetDetail');
        const contentDiv = document.getElementById('targetDetailContent');

        let html = `<p><strong>Target:</strong> ${target.target}</p>`;
        html += `<p><strong>Type:</strong> ${target.type}</p>`;
        html += `<p><strong>Label:</strong> ${target.label || '-'}</p>`;

        if (data.length === 0) {
            html += '<p>No history available</p>';
        } else {
            html += '<h3>History</h3>';
            html += '<table><thead><tr><th>Zone</th><th>Status</th><th>A Records</th><th>Last Checked</th></tr></thead><tbody>';
            data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.zone}</td>
                        <td><span class="badge badge-${item.status === 'listed' ? 'danger' : item.status === 'blocked' ? 'warning' : 'secondary'}">${item.status}</span></td>
                        <td>${item.a_records.join(', ') || '-'}</td>
                        <td>${new Date(item.last_checked).toLocaleString()}</td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
        }

        contentDiv.innerHTML = html;
        detailDiv.style.display = 'block';
        detailDiv.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        console.error('Error loading detail:', error);
        alert('Error loading target detail');
    }
}

function closeDetail() {
    document.getElementById('targetDetail').style.display = 'none';
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('statusFilter').value = '';
    loadTargets();
}

// Load targets on page load
document.addEventListener('DOMContentLoaded', loadTargets);
</script>
{% endblock %}
