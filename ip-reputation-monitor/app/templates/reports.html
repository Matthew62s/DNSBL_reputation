{% extends "base.html" %}

{% block title %}Reports - IP Reputation Monitor{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">Reports</h1>

<!-- Generate Report Form -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Generate Report</div>
    </div>
    <form id="generateReportForm" onsubmit="generateReport(event)">
        <div class="form-group">
            <label for="reportType">Report Type</label>
            <select id="reportType" class="form-control" required>
                <option value="csv">CSV</option>
                <option value="xlsx">Excel (XLSX)</option>
                <option value="pdf">PDF</option>
            </select>
        </div>
        <p style="margin-bottom: 1rem; color: #666;">Reports are generated from the most recent monitoring run.</p>
        <div class="form-group">
            <label for="statusFilter">Status Filter (optional)</label>
            <select id="statusFilter" class="form-control">
                <option value="all">All Statuses</option>
                <option value="listed">Listed Only</option>
                <option value="blocked">Blocked Only</option>
                <option value="error">Error Only</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">üìä Generate Report</button>
    </form>
</div>

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Quick Actions</div>
    </div>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="loadReports()">üîÑ Refresh</button>
    </div>
</div>

<!-- Reports Table -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Reports (<span id="reportCount">0</span>)</div>
    </div>
    <div id="reportsList">
        <p class="loading">Loading reports...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentReports = [];

async function loadReports() {
    try {
        const response = await fetch('/api/reports?limit=50');
        const data = await response.json();
        currentReports = data.items;

        document.getElementById('reportCount').textContent = data.total;

        if (data.items.length === 0) {
            document.getElementById('reportsList').innerHTML = '<p>No reports found</p>';
            return;
        }

        let html = '<table><thead><tr><th>Type</th><th>Status</th><th>Run Scope</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
        data.items.forEach(item => {
            let statusBadge = 'secondary';
            if (item.status === 'completed') statusBadge = 'success';
            else if (item.status === 'failed') statusBadge = 'danger';
            else if (item.status === 'generating') statusBadge = 'warning';

            const runScope = item.date_from || item.date_to ?
                `${item.date_from ? new Date(item.date_from).toLocaleString() : '...'} to ${item.date_to ? new Date(item.date_to).toLocaleString() : '...'}` :
                'Last monitor run';

            html += `
                <tr>
                    <td><strong>${item.report_type.toUpperCase()}</strong></td>
                    <td><span class="badge badge-${statusBadge}">${item.status}</span></td>
                    <td>${runScope}</td>
                    <td>${new Date(item.created_at).toLocaleString()}</td>
                    <td>
                        ${item.status === 'completed' ? `<a href="/api/reports/${item.id}/download" class="btn btn-sm btn-success">Download</a>` : ''}
                        ${item.status === 'pending' || item.status === 'generating' ? '‚è≥ Generating...' : ''}
                        ${item.status === 'failed' ? `<button class="btn btn-sm btn-danger" onclick="showError(${item.id})">Error</button>` : ''}
                        <button class="btn btn-sm btn-danger" onclick="deleteReport(${item.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
        html += '</tbody></table>';
        document.getElementById('reportsList').innerHTML = html;
    } catch (error) {
        console.error('Error loading reports:', error);
        document.getElementById('reportsList').innerHTML = '<p class="alert alert-danger">Error loading reports</p>';
    }
}

async function generateReport(event) {
    event.preventDefault();

    const report_type = document.getElementById('reportType').value;
    const statusFilter = document.getElementById('statusFilter').value;

    try {
        const response = await fetch('/api/reports', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                report_type,
                status_filter: statusFilter === 'all' ? null : statusFilter,
            })
        });

        if (response.ok) {
            const result = await response.json();
            alert(`Report ${result.id} queued for generation!`);
            loadReports();

            // Poll for completion
            pollReportStatus(result.id);
        } else {
            const error = await response.json();
            alert('Failed to generate report: ' + error.detail);
        }
    } catch (error) {
        console.error('Error generating report:', error);
        alert('Error generating report: ' + error.message);
    }
}

async function pollReportStatus(reportId, attempts = 0) {
    if (attempts > 30) return; // Stop after 30 attempts

    try {
        const response = await fetch(`/api/reports/${reportId}`);
        const report = await response.json();

        if (report.status === 'completed' || report.status === 'failed') {
            loadReports();
        } else {
            // Poll again after 2 seconds
            setTimeout(() => pollReportStatus(reportId, attempts + 1), 2000);
        }
    } catch (error) {
        console.error('Error polling report status:', error);
    }
}

async function deleteReport(id) {
    if (!confirm('Are you sure you want to delete this report?')) return;

    try {
        const response = await fetch(`/api/reports/${id}`, { method: 'DELETE' });

        if (response.ok) {
            alert('Report deleted successfully');
            loadReports();
        } else {
            alert('Failed to delete report');
        }
    } catch (error) {
        console.error('Error deleting report:', error);
        alert('Error deleting report: ' + error.message);
    }
}

function showError(id) {
    const report = currentReports.find(r => r.id === id);
    if (report && report.error_message) {
        alert('Report Error: ' + report.error_message);
    }
}

// Load reports on page load
document.addEventListener('DOMContentLoaded', loadReports);

// Auto-refresh reports every 30 seconds
setInterval(loadReports, 30000);
</script>
{% endblock %}
